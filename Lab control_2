import sys
import time
import pandas as pd
import random
from datetime import datetime

import matplotlib
matplotlib.use('QtAgg')
from matplotlib.backends.backend_qtagg import FigureCanvasQTAgg as FigureCanvas
from matplotlib.figure import Figure

from PyQt6.QtWidgets import (QApplication, QMainWindow, QWidget, QVBoxLayout,
                             QHBoxLayout, QLabel, QLineEdit, QPushButton,
                             QTableWidget, QTableWidgetItem, QMessageBox, QTabWidget, 
                             QGroupBox, QGridLayout, QScrollArea)
from PyQt6.QtCore import QThread, pyqtSignal, Qt

# --- æ ¸å¿ƒé€»è¾‘ï¼šå•ä¸ªå™¨ä»¶çš„æ§åˆ¶å™¨ ---
class DeviceLogic:
    def __init__(self, start_t, duration, v_start, v_end):
        self.start_t = start_t
        self.end_t = start_t + duration
        self.v_start = v_start
        self.v_end = v_end

    def get_value(self, elapsed):
        if elapsed < self.start_t:
            return 0.0
        if elapsed >= self.end_t:
            return self.v_end
        # çº¿æ€§æ’å€¼è®¡ç®—å½“å‰æ—¶åˆ»åº”æœ‰çš„è®¾å®šå€¼
        ratio = (elapsed - self.start_t) / (self.end_t - self.start_t)
        return self.v_start + (self.v_end - self.v_start) * ratio

# --- åå°çº¿ç¨‹ï¼šå¤„ç†ç¡¬ä»¶æ•°æ®å’Œé€»è¾‘ ---
class ControlThread(QThread):
    update_signal = pyqtSignal(dict) # å‘é€æ‰€æœ‰æ•°æ®

    def __init__(self, configs):
        super().__init__()
        self.configs = configs # å­˜å‚¨æ¯ä¸ªå™¨ä»¶çš„ DeviceLogic å¯¹è±¡
        self.is_running = True
        self.log = []

    def run(self):
        start_wall_time = time.time()
        while self.is_running:
            elapsed = time.time() - start_wall_time
            
            # è®¡ç®—æ¯ä¸ªå™¨ä»¶å½“å‰çš„è®¾å®šå€¼å¹¶æ¨¡æ‹Ÿè¯»å–å€¼
            current_data = {"elapsed": elapsed, "readings": []}
            setpoints = {}
            
            for name, logic in self.configs.items():
                val = logic.get_value(elapsed)
                setpoints[name] = val
                # æ¨¡æ‹Ÿç¡¬ä»¶è¯»å–å€¼ï¼ˆè®¾å®šå€¼ + éšæœºæ‰°åŠ¨ï¼‰
                noise = random.uniform(-0.1, 0.1) if "F" in name else random.uniform(-0.3, 0.3)
                current_data[name] = val + noise
            
            self.update_signal.emit(current_data)
            
            # å­˜å…¥æ—¥å¿—ç”¨äºå¯¼å‡ºCSV
            timestamp = datetime.now().strftime("%H:%M:%S")
            self.log.append([timestamp, elapsed] + [current_data[f"F{i}"] for i in range(1,5)] + [current_data[f"T{i}"] for i in range(1,3)])
            
            self.msleep(1000)

    def stop(self):
        self.is_running = False
        # å¯¼å‡ºCSV
        cols = ["RealTime", "Elapsed", "F1", "F2", "F3", "F4", "T1", "T2"]
        df = pd.DataFrame(self.log, columns=cols)
        df.to_csv(f"experiment_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv", index=False)
        self.quit()
        self.wait()

# --- ä¸»ç•Œé¢ ---
class MainPanel(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("å¤šè·¯å™¨ä»¶å‚æ•°è®¾ç½®ä¸å®æ—¶æ§åˆ¶ç³»ç»Ÿ")
        self.resize(1100, 900)
        self.device_inputs = {} # å­˜å‚¨ç•Œé¢ä¸Šçš„æ‰€æœ‰è¾“å…¥æ¡†å¯¹è±¡
        self.plot_history = {"t": [], "F1": [], "T1": []}
        self.init_ui()

    def init_ui(self):
        main_widget = QWidget()
        self.setCentralWidget(main_widget)
        layout = QVBoxLayout(main_widget)

        # 1. å‚æ•°è®¾ç½®åŒºåŸŸ (åˆ†æˆæµé‡è®¡å’Œæ¸©åº¦è®¡ä¸¤ç»„)
        settings_layout = QHBoxLayout()
        settings_layout.addWidget(self.create_device_group("æµé‡è®¡ (Flow Meters)", ["F1", "F2", "F3", "F4"], "L/min"))
        settings_layout.addWidget(self.create_device_group("çƒ­ç”µå¶ (Thermocouples)", ["T1", "T2"], "â„ƒ"))
        layout.addLayout(settings_layout)

        # 2. æ§åˆ¶æŒ‰é’®
        btn_layout = QHBoxLayout()
        self.btn_start = QPushButton("ğŸš€ å¼€å§‹æ‰§è¡Œç¨‹åº")
        self.btn_stop = QPushButton("ğŸ›‘ åœæ­¢å¹¶ä¿å­˜æ•°æ®")
        self.btn_stop.setEnabled(False)
        self.btn_start.setStyleSheet("background-color: #d4edda; font-weight: bold; height: 40px;")
        self.btn_stop.setStyleSheet("background-color: #f8d7da; font-weight: bold; height: 40px;")
        btn_layout.addWidget(self.btn_start)
        btn_layout.addWidget(self.btn_stop)
        layout.addLayout(btn_layout)

        # 3. æ•°æ®å±•ç¤º Tab
        self.tabs = QTabWidget()
        layout.addWidget(self.tabs)

        # Tab: å®æ—¶å›¾è¡¨
        self.fig = Figure(figsize=(8, 5))
        self.canvas = FigureCanvas(self.fig)
        self.tabs.addTab(self.canvas, "å®æ—¶èµ°åŠ¿å›¾")

        # Tab: æ•°æ®åˆ—è¡¨
        self.table = QTableWidget(0, 7)
        self.table.setHorizontalHeaderLabels(["æ—¶é—´", "F1", "F2", "F3", "F4", "T1", "T2"])
        self.tabs.addTab(self.table, "æ•°å€¼åˆ—è¡¨")

        # ä¿¡å·è¿æ¥
        self.btn_start.clicked.connect(self.run_experiment)
        self.btn_stop.clicked.connect(self.stop_experiment)

    def create_device_group(self, title, dev_list, unit):
        group = QGroupBox(title)
        grid = QGridLayout()
        
        headers = ["å¼€å§‹(s)", "æŒç»­(s)", f"èµ·å§‹({unit})", f"ç›®æ ‡({unit})"]
        for j, h in enumerate(headers):
            grid.addWidget(QLabel(f"<b>{h}</b>"), 0, j+1)

        for i, dev in enumerate(dev_list):
            grid.addWidget(QLabel(f"<b>{dev}:</b>"), i+1, 0)
            
            # åˆ›å»ºå››ä¸ªè¾“å…¥æ¡†å¹¶å­˜å…¥å­—å…¸
            self.device_inputs[f"{dev}_start"] = QLineEdit("0")
            self.device_inputs[f"{dev}_dur"] = QLineEdit("30")
            self.device_inputs[f"{dev}_v1"] = QLineEdit("0")
            self.device_inputs[f"{dev}_v2"] = QLineEdit("10" if "F" in dev else "100")
            
            grid.addWidget(self.device_inputs[f"{dev}_start"], i+1, 1)
            grid.addWidget(self.device_inputs[f"{dev}_dur"], i+1, 2)
            grid.addWidget(self.device_inputs[f"{dev}_v1"], i+1, 3)
            grid.addWidget(self.device_inputs[f"{dev}_v2"], i+1, 4)

        group.setLayout(grid)
        return group

    def run_experiment(self):
        configs = {}
        try:
            for dev in ["F1", "F2", "F3", "F4", "T1", "T2"]:
                st = float(self.device_inputs[f"{dev}_start"].text())
                du = float(self.device_inputs[f"{dev}_dur"].text())
                v1 = float(self.device_inputs[f"{dev}_v1"].text())
                v2 = float(self.device_inputs[f"{dev}_v2"].text())
                configs[dev] = DeviceLogic(st, du, v1, v2)
        except ValueError:
            QMessageBox.warning(self, "è¾“å…¥é”™è¯¯", "è¯·ç¡®ä¿æ‰€æœ‰è®¾ç½®å‚æ•°å‡ä¸ºæ•°å­—ã€‚")
            return

        self.plot_history = {"t": [], "F1": [], "T1": []}
        self.thread = ControlThread(configs)
        self.thread.update_signal.connect(self.handle_update)
        self.thread.start()
        
        self.btn_start.setEnabled(False)
        self.btn_stop.setEnabled(True)

    def stop_experiment(self):
        self.thread.stop()
        self.btn_start.setEnabled(True)
        self.btn_stop.setEnabled(False)
        QMessageBox.information(self, "å®Œæˆ", "å®éªŒå·²åœæ­¢ï¼Œæ•°æ®å·²å¯¼å‡ºä¸ºCSVæ–‡ä»¶ã€‚")

    def handle_update(self, data):
        # æ›´æ–°å›¾è¡¨æ•°æ®
        self.plot_history["t"].append(data["elapsed"])
        self.plot_history["F1"].append(data["F1"])
        self.plot_history["T1"].append(data["T1"])
        self.update_chart()

        # æ›´æ–°è¡¨æ ¼
        row_pos = self.table.rowCount()
        self.table.insertRow(row_pos)
        self.table.setItem(row_pos, 0, QTableWidgetItem(datetime.now().strftime("%H:%M:%S")))
        for i, dev in enumerate(["F1", "F2", "F3", "F4", "T1", "T2"]):
            self.table.setItem(row_pos, i+1, QTableWidgetItem(f"{data[dev]:.2f}"))
        self.table.scrollToBottom()

    def update_chart(self):
        self.fig.clear()
        ax1 = self.fig.add_subplot(111)
        ax2 = ax1.twinx()

        ax1.plot(self.plot_history["t"], self.plot_history["F1"], 'b-', label='F1 æµé‡')
        ax2.plot(self.plot_history["t"], self.plot_history["T1"], 'r-', label='T1 æ¸©åº¦')
        
        ax1.set_xlabel("æ—¶é—´ (s)")
        ax1.set_ylabel("æµé‡ (L/min)", color='b')
        ax2.set_ylabel("æ¸©åº¦ (â„ƒ)", color='r')
        ax1.legend(loc='upper left')
        ax2.legend(loc='upper right')
        self.canvas.draw()

if __name__ == "__main__":
    app = QApplication(sys.argv)
    window = MainPanel()
    window.show()
    sys.exit(app.exec())
